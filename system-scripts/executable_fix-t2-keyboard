#!/bin/sh
# Systemd sleep hook to fix T2 keyboard delay on resume
# This script unbinds/rebinds the keyboard USB device to force immediate reinitialization
# Managed by chezmoi - do not edit directly in /etc/systemd/system-sleep/

# Debug: log all invocations
logger -t fix-t2-keyboard "Script called with args: $1 $2"

case "$1" in
  post)
    # After resume, find and rebind the keyboard device in background
    # The keyboard is part of the BCE virtual HCI controller
    # Run in background with timeout to prevent blocking suspend/resume
    (
      # Set a timeout for the entire operation
      exec 2>/dev/null

      for device in /sys/bus/usb/devices/*/product; do
        if timeout 1 grep -q "Apple Internal Keyboard" "$device" 2>/dev/null; then
          device_path=$(dirname "$device")
          device_name=$(basename "$device_path")

          logger -t fix-t2-keyboard "Found keyboard device $device_name, rebinding..."

          # Unbind with timeout - if this hangs, the timeout will kill it
          if timeout 2 sh -c "echo '$device_name' > /sys/bus/usb/drivers/usb/unbind" 2>/dev/null; then
            logger -t fix-t2-keyboard "Unbound $device_name"
          else
            logger -t fix-t2-keyboard "Unbind timed out or failed for $device_name"
          fi

          # Brief delay
          sleep 0.5

          # Rebind with timeout
          if timeout 2 sh -c "echo '$device_name' > /sys/bus/usb/drivers/usb/bind" 2>/dev/null; then
            logger -t fix-t2-keyboard "Rebound keyboard device $device_name successfully"
          else
            logger -t fix-t2-keyboard "Rebind timed out or failed for $device_name"
          fi

          break
        fi
      done
    ) &

    # Don't wait for background job - exit immediately to not block systemd
    ;;
esac
