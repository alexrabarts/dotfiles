# Initialize completion system first
autoload -Uz compinit && compinit

eval "$(starship init zsh)"

{{ if eq .chezmoi.os "darwin" -}}
alias tailscale="/Applications/Tailscale.app/Contents/MacOS/Tailscale"
{{- end }}

# Chezmoi
alias cz="chezmoi"
alias czap="chezmoi apply && exec zsh"
alias cze="chezmoi edit"
alias czd="chezmoi diff"
alias ta="tmux attach"

# Editor configuration
if command -v nvim >/dev/null 2>&1; then
  export EDITOR=nvim
  export VISUAL=nvim
  alias vim=nvim
  alias vi=nvim
elif command -v vim >/dev/null 2>&1; then
  export EDITOR=vim
  export VISUAL=vim
else
  export EDITOR=vi
  export VISUAL=vi
fi

# PATH helper function - prepends to PATH only if not already present
__path_prepend() {
  case ":$PATH:" in
    *:"$1":*) ;;
    *) export PATH="$1:$PATH" ;;
  esac
}

# Local bin directory for utility scripts
__path_prepend "$HOME/bin"

# Go
__path_prepend "$HOME/go/bin"        # For go install binaries
__path_prepend "$HOME/local/go/bin"  # For go itself

# The next line updates PATH for the Google Cloud SDK.
if [ -f "$HOME/work/google-cloud-sdk/path.zsh.inc" ]; then . "$HOME/work/google-cloud-sdk/path.zsh.inc"; fi

# The next line enables shell command completion for gcloud.
if [ -f "$HOME/work/google-cloud-sdk/completion.zsh.inc" ]; then . "$HOME/work/google-cloud-sdk/completion.zsh.inc"; fi

__path_prepend "/opt/homebrew/opt/libpq/bin"

# Tab completion for pg command
__pg_completion() {
  local -a databases
  if [ -f ~/.pgpass ]; then
    # Extract unique database names from .pgpass
    databases=(${(f)"$(awk -F: '{print $3}' ~/.pgpass | sort -u)"})
  fi
  _describe 'database' databases
}

compdef __pg_completion pg

oc() { opencode "$@" }

# Export environment variables
if [ -f "$HOME/.env" ]; then
  set -a
  source "$HOME/.env"
  set +a
fi

eval "$(atuin init zsh)"

# opencode
__path_prepend "$HOME/.opencode/bin"

# bun completions
[ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"

# bun
export BUN_INSTALL="$HOME/.bun"
__path_prepend "$BUN_INSTALL/bin"

# claude
alias claude="$HOME/.claude/local/claude"
