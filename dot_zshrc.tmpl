# Initialize zoxide before instant prompt to avoid timing issues
eval "$(zoxide init --cmd cd zsh)"

# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

{{ if eq .chezmoi.os "darwin" -}}
export TERM=xterm-256color
{{- end }}

# Initialize completion system first
autoload -Uz compinit && compinit

# Zinit and plugins dir
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
if [ ! -d "$ZINIT_HOME" ]; then
  mkdir -p "$(dirname $ZINIT_HOME)"
  git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
fi
source "${ZINIT_HOME}/zinit.zsh"

#eval "$(starship init zsh)"
zinit ice depth=1; zinit light romkatv/powerlevel10k
zinit light zsh-users/zsh-syntax-highlighting
zinit light zsh-users/zsh-completions
autoload -U compinit && compinit

# Override syntax highlighting colors - use darker amber for invalid commands
ZSH_HIGHLIGHT_STYLES[unknown-token]='fg=130'  # dark amber for invalid/unknown commands

# Colored autocompletion
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"

{{ if eq .chezmoi.os "darwin" -}}
alias tailscale="/Applications/Tailscale.app/Contents/MacOS/Tailscale"
{{- end }}

alias ls='ls --color'
alias ca='chezmoi apply'

# Chezmoi
alias cz="chezmoi"
alias czap="chezmoi apply && exec zsh"
alias cze="chezmoi edit"
alias czd="chezmoi diff"
alias ta="tmux attach"

# Emacs-style keybindings
bindkey -e

# Editor configuration
if command -v nvim >/dev/null 2>&1; then
  export EDITOR=nvim
  export VISUAL=nvim
  alias vim=nvim
  alias vi=nvim
elif command -v vim >/dev/null 2>&1; then
  export EDITOR=vim
  export VISUAL=vim
else
  export EDITOR=vi
  export VISUAL=vi
fi

# PATH helper function - prepends to PATH only if not already present
__path_prepend() {
  case ":$PATH:" in
    *:"$1":*) ;;
    *) export PATH="$1:$PATH" ;;
  esac
}

# Local bin directory for utility scripts
__path_prepend "$HOME/bin"

__path_prepend "$HOME/.local/bin"

# Go
__path_prepend "$HOME/go/bin"        # For go install binaries
__path_prepend "$HOME/local/go/bin"  # For go itself

{{ if eq .chezmoi.os "darwin" -}}
# Homebrew-based Google Cloud SDK (gcloud-cli formula)
if command -v brew >/dev/null 2>&1; then
  gcloud_prefix="$(brew --prefix)/share/google-cloud-sdk"
  if [ -d "$gcloud_prefix/bin" ]; then
    [ -f "$gcloud_prefix/path.zsh.inc" ] && . "$gcloud_prefix/path.zsh.inc"
    [ -f "$gcloud_prefix/completion.zsh.inc" ] && . "$gcloud_prefix/completion.zsh.inc"
  fi
fi
{{- end }}

# Fallback for manually installed Google Cloud SDK
if [ -f "$HOME/work/google-cloud-sdk/path.zsh.inc" ]; then . "$HOME/work/google-cloud-sdk/path.zsh.inc"; fi
if [ -f "$HOME/work/google-cloud-sdk/completion.zsh.inc" ]; then . "$HOME/work/google-cloud-sdk/completion.zsh.inc"; fi

__path_prepend "/opt/homebrew/opt/libpq/bin"

# Tab completion for pg command
__pg_completion() {
  local -a databases
  if [ -f ~/.pgpass ]; then
    # Extract unique database names from .pgpass
    databases=(${(f)"$(awk -F: '{print $3}' ~/.pgpass | sort -u)"})
  fi
  _describe 'database' databases
}

compdef __pg_completion pg

oc() { opencode "$@" }

# Export environment variables
if [ -f "$HOME/.env" ]; then
  set -a
  source "$HOME/.env"
  set +a
fi

# Set default browser
xdg-settings set default-web-browser chromium.desktop 2>/dev/null

eval "$(atuin init zsh)"

# opencode
__path_prepend "$HOME/.opencode/bin"

# bun completions
[ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"

# bun
export BUN_INSTALL="$HOME/.bun"
__path_prepend "$BUN_INSTALL/bin"

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
