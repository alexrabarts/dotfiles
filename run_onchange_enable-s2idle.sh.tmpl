#!/usr/bin/env bash
set -euo pipefail

{{- if eq .chezmoi.os "linux" }}

# Only configure s2idle on desktop environments (detected by Hyprland installation)
if ! command -v Hyprland >/dev/null 2>&1; then
  echo "Skipping s2idle configuration (Hyprland not installed)"
  exit 0
fi

echo "Configuring system suspend mode (s2idle)..."

SOURCE_DIR="${CHEZMOI_SOURCE_DIR:-$HOME/.local/share/chezmoi}"

sudo install -D -m 755 "${SOURCE_DIR}/system-scripts/executable_set-s2idle" /usr/local/sbin/set-s2idle
sudo install -D -m 644 "${SOURCE_DIR}/etc/systemd/system/set-s2idle.service" /etc/systemd/system/set-s2idle.service

sudo systemctl daemon-reload
sudo systemctl enable --now set-s2idle.service
sudo systemctl restart set-s2idle.service

CURRENT_STATE=$(cat /sys/power/mem_sleep 2>/dev/null || echo "unknown")
echo "  ✓ mem_sleep now reports: ${CURRENT_STATE}"
echo "✓ s2idle configuration applied"

{{- else }}

# Skipping s2idle configuration (Linux only)
exit 0

{{- end }}
